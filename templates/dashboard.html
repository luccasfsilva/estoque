from flasgger import swag_from
from flask_jwt_extended import get_jwt_identity, jwt_required
from flask_restful import Resource
from flask import jsonify
from src.models import Usuario
import random  # Para gerar dados de exemplo

class ProfileResource(Resource):
    @swag_from({
        'tags': ['Usuário'],
        'summary': 'Obter dados do perfil autenticado com gráficos',
        'security': [{'BearerAuth': []}],
        'responses': {
            200: {
                'description': 'Perfil do usuário com gráficos',
                'content': {
                    'application/json': {
                        'example': {
                            "id": 1,
                            "username": "detetivezin",
                            "charts": {
                                "bar": {
                                    "labels": ["Jan", "Fev", "Mar", "Abr", "Mai"],
                                    "datasets": [{"label": "Atividades", "data": [12, 19, 3, 5, 2]}]
                                },
                                "pie": {
                                    "labels": ["Tipo A", "Tipo B", "Tipo C"],
                                    "datasets": [{"data": [30, 50, 20]}]
                                },
                                "line": {
                                    "labels": ["Seg", "Ter", "Qua", "Qui", "Sex"],
                                    "datasets": [{"label": "Progresso", "data": [65, 59, 80, 81, 56]}]
                                },
                                "tower": {
                                    "labels": ["Categoria 1", "Categoria 2", "Categoria 3"],
                                    "datasets": [{"label": "Valores", "data": [25, 40, 30]}]
                                }
                            }
                        }
                    }
                }
            },
            401: {'description': 'Token inválido ou expirado'},
            404: {'description': 'Usuário não encontrado'}
        }
    })
    @jwt_required()
    def get(self):
        user_id = get_jwt_identity()
        user = Usuario.query.get(user_id)
        
        if not user:
            return {"message": "Usuário não encontrado"}, 404
        
        # ===== DADOS PARA GRÁFICOS (EXEMPLO) =====
        # Substituir com sua lógica real de obtenção de dados
        
        # Gráfico de Barras (Atividades mensais)
        bar_data = {
            "labels": ["Jan", "Fev", "Mar", "Abr", "Mai"],
            "datasets": [{
                "label": "Atividades",
                "data": [random.randint(1,20) for _ in range(5)]
            }]
        }
        
        # Gráfico de Pizza (Distribuição de tipos)
        pie_data = {
            "labels": ["Tipo A", "Tipo B", "Tipo C"],
            "datasets": [{
                "data": [random.randint(10,50) for _ in range(3)]
            }]
        }
        
        # Gráfico de Linha (Progresso semanal)
        line_data = {
            "labels": ["Seg", "Ter", "Qua", "Qui", "Sex"],
            "datasets": [{
                "label": "Progresso",
                "data": [random.randint(50,100) for _ in range(5)]
            }]
        }
        
        # Gráfico de Torre (Comparação de categorias)
        tower_data = {
            "labels": ["Categoria 1", "Categoria 2", "Categoria 3"],
            "datasets": [{
                "label": "Valores",
                "data": [random.randint(20,50) for _ in range(3)]
            }]
        }
        # ===== FIM DOS DADOS EXEMPLO =====

        return jsonify({
            "id": user.id,
            "username": user.username,
            "charts": {
                "bar": bar_data,
                "pie": pie_data,
                "line": line_data,
                "tower": tower_data
            }
        })
